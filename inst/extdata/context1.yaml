modules:
  NA handling: &NaHandling
    type: pipe
    Fill NAs:
      type: transformation
      function: zoo::na.locf
      arguments:
        object: '@pipe'
    NA Ratio:
      type: warning
      function: NaRatio
      arguments:
        timeseries: '@pipe'
        variable: Close
        maxRatio: 0.25
data:
  SPX:
    type: pipe
    longname: "S&P 500 daily close"
    description: |
      Quandl, fill missing values with Yahoo.
      Backfill weekends and holidays.
      Cache for an hour.
      Warn if newest value older than a day.
    variables:
      series: Close
      maxNaRatio: 0.25
      yahooSymbol: "^GSPC"
      quandlCode: "YAHOO/INDEX_GSPC"
    Transformation:
      type: pipe
      Cache:
        type: function
        function: Cache
        arguments:
          f: '@pipe'
          timeout: 3600
      Close:
        type: transformation
        function: magrittr::use_series
        arguments:
          a: '@pipe'
          b: 'Close'
    NAs: *NaHandling
    Regularize:
        type: transformation
        function: Regularize
        arguments:
          xts: '@pipe'
    Combine:
      type: junction
      function: Combine
      arguments:
        listofxts: '@pipe'
      Quandl:
        type: pipe
        MinLength:
          type: error
          function: MinLength
          arguments:
            timeseries: '@pipe'
            minLength: 10
        Quandl:
          type: transformation
          function: Quandl::Quandl
          arguments:
            code: "@quandlCode"
            type: xts
      Yahoo:
        type: pipe
        MinLength:
          type: warning
          function: MinLength
          arguments:
            timeseries: '@pipe'
            minLength: 10
        SetNames:
          type: transformation
          function: SetNames
          arguments:
            x: '@pipe'
            names: [Open, High, Low, Close, Volume, 'Adjusted Close']
          Yahoo:
            type: transformation
            function: quantmod::getSymbols
            arguments:
              Symbols: "^GSPC"
              auto.assign: FALSE

#TODO: inheritable args
#TODO: anchors/modules


